!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.shin=t()}(this,function(){"use strict";function e(e,t){return Math.floor(Math.random()*(e-t+1)+t)}function t(e,t){return parseFloat(e.toFixed(t))}function r(e){return t(e/1024,2)}function n(e){return e.replace(/"/g,"")}function i(){return performance.now()}function o(e){if(!e)return null;var t=E;for(var r in e){var n=e[r];if("object"==typeof n)for(var i in n)t[r][i]=n[i];else t[r]=n}var o=t.identity.getFunc;o&&o(t);var a=new c(t);a.registerErrorEvent(),a.registerUnhandledrejectionEvent(),a.registerLoadEvent(),a.recordPage(),y.reactError=a.reactError.bind(a),y.vueError=a.vueError.bind(a);var s=new v(t);s.observerLCP(),s.observerFID(),s.registerLoadAndHideEvent();var d=new u(t);return d.injectConsole(),d.injectRouter(),d.injectEvent(),d.injectAjax(),t}var a={ACTION_ERROR:"error",ACTION_AJAX:"ajax",ACTION_EVENT:"event",ACTION_PRINT:"console",ACTION_REDIRECT:"redirect",ERROR_RUNTIME:"runtime",ERROR_SCRIPT:"script",ERROR_STYLE:"style",ERROR_IMAGE:"image",ERROR_AUDIO:"audio",ERROR_VIDEO:"video",ERROR_PROMISE:"promise",ERROR_VUE:"vue",ERROR_REACT:"react",ERROR_CRASH:"crash",LOAD_ERROR_TYPE:{SCRIPT:"script",LINK:"style",IMG:"image",AUDIO:"audio"}},s=function(){function r(e){this.params=e}return r.prototype.getIdentity=function(){var e="shin-monitor-identity",t=sessionStorage.getItem(e);if(!t){t=Number(Math.random().toString().substring(3,6)+Date.now()).toString(36);var r=this.params.identity.value;r&&(t=r+"-"+t),sessionStorage.setItem(e,t)}return t},r.prototype.paramify=function(e){return e.author=this.params.author,e.token=this.params.token,e.subdir=this.params.subdir,e.identity=this.getIdentity(),e.referer=location.href,JSON.stringify(e)},r.prototype.send=function(e,t){var r=this.paramify(e);if(!(r.length>=8e3)){var n={m:r};t&&t(e,n),fetch(this.params.src,{method:"POST",body:JSON.stringify(n)})}},r.prototype.paramifyPerformance=function(e){e.token=this.params.token,e.pkey=this.params.pkey,e.identity=this.getIdentity(),e.referer=location.href;var r=performance.getEntriesByType("resource"),n=[];return r&&r.forEach(function(e){"fetch"!==e.initiatorType&&(e.startTime>6e4||n.push({name:e.name,duration:t(e.duration),startTime:t(e.startTime)}))}),e.resource=n,JSON.stringify(e)},r.prototype.sendPerformance=function(t){var r=this.paramifyPerformance(t),n=e(10,1);this.params.rate>=n&&this.params.pkey&&navigator.sendBeacon(this.params.psrc,r)},r}(),c=function(){function e(e){this.params=e,this.recordEventsMatrix=[[]],this.http=new s(e)}return e.prototype.registerErrorEvent=function(){var e=this,t=this.params.error.isFilterErrorFunc;window.addEventListener("error",function(r){var n=r.target;t&&t(r)||(n!==window&&n.nodeName&&a.LOAD_ERROR_TYPE[n.nodeName.toUpperCase()]?e.handleError(e.formatLoadError(n)):r.message&&e.handleError(e.formatRuntimerError(r.message,r.filename,r.lineno,r.colno)))},!0)},e.prototype.registerUnhandledrejectionEvent=function(){var e=this,t=this.params.error.isFilterPromiseFunc;window.addEventListener("unhandledrejection",function(r){var n=r.reason.response;if(n&&n.request){var i=n.request.ajax;i.status=r.reason.status||n.status,t&&t(i)||e.handleError({type:a.ERROR_PROMISE,desc:i})}},!0)},e.prototype.recordPage=function(){var e=this,t=this.params.record,r=t.isOpen,n=t.src;if(r){var i=document.createElement("script");i.src=n,i.onload=function(){rrweb.record({emit:function(t,r){if(r){var n=e.recordEventsMatrix.length-2;n>0&&e.recordEventsMatrix.splice(0,n),e.recordEventsMatrix.push([])}e.recordEventsMatrix[e.recordEventsMatrix.length-1].push(t)},checkoutEveryNms:1e4})},setTimeout(function(){document.head&&document.head.appendChild(i)},0)}},e.prototype.getRecentRecord=function(){var e=this.recordEventsMatrix.length;if(0===e)return"";var t;return t=e>=2?this.recordEventsMatrix[e-2].concat(this.recordEventsMatrix[e-1]):this.recordEventsMatrix[e-1],JSON.stringify(t)},e.prototype.handleCrashParams=function(e,t){if(e.category===a.ACTION_ERROR&&e.data.type===a.ERROR_CRASH){var r=this.getRecentRecord();r.length>0&&(t.r=r)}},e.prototype.isWhiteScreen=function(){var e=[],t=[],r=function(n){var i=n.tagName.toLowerCase(),o=n.getBoundingClientRect(),a={id:n.id,tag:i,className:n.className,display:n.style.display,height:o.height},s=n.src;s&&(a.src=s);var c=n.href;if(c&&(a.href=c),t.push(a),!(e.length>0)&&"none"!==n.style.display)return o.height>0&&"body"!==i?void e.push(n):void(n.children&&[].slice.call(n.children).forEach(function(e){var t=e.tagName.toLowerCase();"script"!==t&&"link"!==t&&r(e)}))};return r(document.body),{visibles:e,nodes:t}},e.prototype.handleError=function(e){this.params.version&&(e.version=this.params.version),this.http.send({category:a.ACTION_ERROR,data:e},this.handleCrashParams.bind(this))},e.prototype.monitorCrash=function(){var e=this,t=this.params.crash,r=t.isOpen,i=t.validateFunc;if(r){var o=function(){if(i){var t=i();t&&!t.success&&(e.handleError({type:a.ERROR_CRASH,desc:{prompt:t.prompt,url:location.href}}),clearInterval(s))}else{var r=e.isWhiteScreen();if(r.visibles.length>0)return;var o=document.querySelector("div");e.handleError({type:a.ERROR_CRASH,desc:{prompt:"页面没有高度",url:location.href,html:o?n(o.innerHTML):"",fontSize:document.documentElement.style.fontSize,nodes:r.nodes}}),clearInterval(s)}},s=setInterval(o,5e3);o(),setTimeout(function(){clearInterval(s)},3e5)}},e.prototype.formatLoadError=function(e){var t={url:e.baseURI,src:e.src||e.href};if(e.error){var r={1:"用户取消操作",2:"网络错误",3:"解码错误",4:"不支持的媒体资源格式"},n=e.error.code;n&&(t.message=r[n])}return{type:a.LOAD_ERROR_TYPE[e.nodeName.toUpperCase()],desc:t}},e.prototype.formatRuntimerError=function(e,t,r,n){return{type:a.ERROR_RUNTIME,lineno:r,colno:n,desc:{prompt:e+" at "+t+":"+r+":"+n,url:location.href}}},e.prototype.reactError=function(e,t){this.handleError({type:a.ERROR_REACT,desc:{prompt:e.toString(),url:location.href},stack:t.componentStack})},e.prototype.vueError=function(e){var t=this,r=e.config.errorHandler;e.config.errorHandler=function(e,n,i){t.handleError({type:a.ERROR_VUE,desc:{prompt:e.toString(),url:location.href},stack:e.stack}),"undefined"!=typeof console&&void 0!==console.error&&console.error(e),"function"==typeof r&&r.call(e,n,i)}},e.prototype.registerLoadEvent=function(){var e=this;window.addEventListener("load",function(){setTimeout(function(){e.monitorCrash()},1e3)})},e}(),u=function(){function e(e){this.params=e,this.http=new s(e),this.refer=location.href}return e.prototype.handleNumber=function(e){var r=typeof e;if("object"===r&&null!==r)for(var n in e)e[n]=this.handleNumber(e[n]);return"number"===r?t(e,2):e},e.prototype.handleAction=function(e,t){this.http.send({category:e,data:this.handleNumber(t)})},e.prototype.injectConsole=function(){var e=this,t=this.params.console,r=t.isOpen,n=t.isFilterLogFunc;r&&["log"].forEach(function(t){var r=console[t];console[t]=function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];r.apply(e,i);var s=[],c=JSON.stringify(i,function(e,t){if("object"==typeof t&&null!==t){if(s.indexOf(t)>=0)return;s.push(t)}return t});n&&n(c)||e.handleAction(a.ACTION_PRINT,{type:t,desc:c})}})},e.prototype.sendRouterInfo=function(){var e=location.href;this.handleAction(a.ACTION_REDIRECT,{refer:this.refer,current:e}),this.refer=e},e.prototype.injectRouter=function(){var e=this,t=window.onpopstate;window.onpopstate=function(r){e.sendRouterInfo(),t&&t.apply(e,r)};var r=function(t){var r=history[t];return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var i=r.apply(history,t);return e.sendRouterInfo(),i}};history.pushState=r("pushState"),history.replaceState=r("replaceState")},e.prototype.network=function(){var e=window.navigator,t=e.connection,r=t&&t.effectiveType;if(r)return{bandwidth:0,type:r.toUpperCase()};var n="Unknown Ethernet WIFI 2G 3G 4G".split(" "),i={bandwidth:0,type:""};return t&&t.type&&(i.type=n[t.type]),i},e.prototype.handleEvent=function(e,t){var r=this;return function(i){t(i)&&r.handleAction(a.ACTION_EVENT,{type:e,desc:n(i.target.outerHTML)})}},e.prototype.injectEvent=function(){var e=this;window.addEventListener("click",this.handleEvent("click",function(t){var r=t.target;if("body"===r.nodeName.toLowerCase())return!1;var n=e.params.event.isFilterClickFunc;return!n||!n(r)}),!1)},e.prototype.injectAjax=function(){var e=this,n=this.params.ajax.isFilterSendFunc,o=window.XMLHttpRequest;window.XMLHttpRequest=function(){var e=new o;return s(e),e};var s=function(o){o.ajax={};var s,c=e;o.addEventListener("readystatechange",function(){if(4==this.readyState){var e=o.responseType;if(e&&"text"!=e&&"json"!=e)return;var u=void 0,d=void 0;try{"text"===e?(u=o.responseText,d=o.responseText):(u=JSON.stringify(o.response),d=o.response)}catch(e){u="",d={}}var p=i();o.ajax.status=o.status,o.status>=200&&o.status<300||304==o.status?o.ajax.endBytes=r(2*u.length)+"KB":o.ajax.endBytes=0;var f=o.getResponseHeader("req-id");if(f&&(o.ajax.header?o.ajax.header["req-id"]=f:o.ajax.header={"req-id":f}),o.ajax.interval=t(p-s,2)+"ms",o.ajax.network=c.network(),u.length<=6e3&&(o.ajax.response=d),n&&n(o))return;c.handleAction(a.ACTION_AJAX,o.ajax)}},!1);var u=o.open;o.open=function(e,t){return o.ajax.type=e,o.ajax.url=t,u.apply(o,arguments)};var d=o.setRequestHeader;o.setRequestHeader=function(e,t){var r;return"Authorization"===e&&(o.ajax.header=(r={},r[e]=t,r)),d.apply(o,arguments)};var p=o.send;o.send=function(e){return s=i(),e&&(o.ajax.startBytes=r(2*JSON.stringify(e).length)+"KB",o.ajax.data=e),p.apply(o,arguments)}}},e}(),d=function(){return d=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},d.apply(this,arguments)},p=["SCRIPT","STYLE","META","HEAD","LINK"],f={SVG:2,IMG:2,CANVAS:4,OBJECT:4,EMBED:4,VIDEO:4},l=window.innerWidth,h=window.innerHeight,m=function(){function e(){var e=this;this.cacheTrees=[],this.callbackCount=0,this.observer=new MutationObserver(function(){var t=[];document.body&&e.doTag(document.body,e.callbackCount++,t),e.cacheTrees.push({ts:performance.now(),children:t})}),this.observer.observe(document,{childList:!0,subtree:!0})}return e.prototype.doTag=function(e,t,r){var n=e.children?e.children.length:0;if(0!==n)for(var i=e.children,o=n-1;o>=0;o--){var a=i[o],s=a.tagName;null===a.getAttribute("_ts")&&-1===p.indexOf(s)&&(a.setAttribute("_ts",t.toString()),r.push(a)),this.doTag(a,t,r)}},e.prototype.isOutScreen=function(e){var t=e.getBoundingClientRect(),r=t.left,n=t.top;return h<n||l<r},e.prototype.getFMP=function(){var e=this;this.observer.disconnect();var t={score:-1,elements:[],ts:0};return this.cacheTrees.forEach(function(r){var n=0,i=[];r.children.forEach(function(t){if(!(1!==t.nodeType||p.indexOf(t.tagName)>=0)){t.getBoundingClientRect().height>0&&!e.isOutScreen(t)&&i.push(t)}}),i=i.filter(function(t){var r=!i.some(function(e){return t!==e&&t.contains(e)});return r&&(n+=e.caculateScore(t)),r}),t.score<n&&(t.score=n,t.elements=i,t.ts=r.ts)}),this.getElementMaxTimeConsuming(t.elements,t.ts)},e.prototype.caculateScore=function(e){var t=e.getBoundingClientRect(),r=t.width,n=t.height,i=f[e.tagName]||1;return 1===i&&window.getComputedStyle(e)["background-image"]&&"initial"!==window.getComputedStyle(e)["background-image"]&&(i=f.IMG),r*n*i},e.prototype.getElementMaxTimeConsuming=function(e,t){var r=this,n={};performance.getEntries().forEach(function(e){n[e.name]=e.responseEnd});var i={ts:t,element:""};return e.forEach(function(e){var t=e.getAttribute("_ts"),o=t?r.cacheTrees[t].ts:0;switch(e.tagName){case"IMG":o=n[e.src];break;case"VIDEO":o=n[e.src],!o&&(o=n[e.poster]);break;default:var a=window.getComputedStyle(e)["background-image"].match(/url\(\"(.*?)\"\)/);if(!a)break;var s=void 0;a&&a[1]&&(s=a[1]),-1==s.indexOf("http")&&(s=location.protocol+a[1]),o=n[s]}o>i.ts&&(i.ts=o,i.element=e)}),i},e}(),v=function(){function e(e){this.fmpObj=new m,this.http=new s(e),this.isNeedHideEvent=!0,this.lcp={time:0,url:"",element:""},this.fmp={time:0,element:""},this.fid=0}return e.prototype.setTimingDefaultValue=function(e){0===e.redirectStart&&(e.redirectStart=e.navigationStart),0===e.redirectEnd&&(e.redirectEnd=e.navigationStart),0===e.loadEventStart&&(e.loadEventStart=e.domComplete),0===e.loadEventEnd&&(e.loadEventEnd=e.loadEventStart)},e.prototype.getTiming=function(){var e=performance.getEntriesByType("navigation")[0]||performance.timing,r=0;if(!e)return{now:r};var n;if(void 0===e.startTime){n=e.navigationStart;var o={};for(var a in e)o[a]=e[a];return this.setTimingDefaultValue(o),r=(new Date).getTime()-n,{timing:o,navigationStart:n,now:t(r)}}return n=e.startTime,r=i()-n,{timing:e,navigationStart:n,now:t(r)}},e.prototype.checkSupportPerformanceObserver=function(e){if(!window.PerformanceObserver)return!1;var t=PerformanceObserver.supportedEntryTypes;return!(!t||-1===t.indexOf(e))},e.prototype.observerLCP=function(){var e=this,r="largest-contentful-paint";if(this.checkSupportPerformanceObserver(r)){var i=new PerformanceObserver(function(r){var i=r.getEntries(),o=i[i.length-1];e.lcp={time:t(o.renderTime||o.loadTime),url:o.url,element:o.element?n(o.element.outerHTML):""}});i.observe({type:r,buffered:!0}),["keydown","click"].forEach(function(e){window.addEventListener(e,function(){i.disconnect()},{once:!0,capture:!0})})}},e.prototype.observerFID=function(){var e=this;this.checkSupportPerformanceObserver("first-input")&&new PerformanceObserver(function(r,n){var i=r.getEntries(),o=i[0];e.fid=t(o.processingStart-o.startTime),n.disconnect()}).observe({type:"first-input",buffered:!0})},e.prototype.countAllElementsOnPage=function(){for(var e=[document.documentElement],t=0,r=0,n=0;e.length;){r++;for(var i=[],o=0,a=e;o<a.length;o++){var s=a[o];t++,i.push.apply(i,Array.from(s.children)),n=Math.max(n,s.children.length)}e=i}return{maxDOMTreeDepth:r,maxChildrenCount:n,totalElementCount:t}},e.prototype.getTimes=function(){var e=this.getTiming(),r=e.timing,o=this.countAllElementsOnPage(),a=d({},o);if(!r)return null;var s=e.navigationStart;a.loadTime=r.loadEventEnd-s,a.unloadEventTime=r.unloadEventEnd-r.unloadEventStart,a.loadEventTime=r.loadEventEnd-r.loadEventStart,a.interactiveTime=r.domInteractive-s,a.domReadyTime=r.domContentLoadedEventEnd-s;var c=performance.getEntriesByType("paint");c&&r.entryType&&c[0]?(a.firstPaint=c[0].startTime-r.fetchStart,a.firstPaintStart=c[0].startTime):a.firstPaint=r.responseEnd-r.fetchStart,c&&r.entryType&&c[1]?(a.firstContentfulPaint=c[1].startTime-r.fetchStart,a.firstContentfulPaintStart=c[1].startTime):a.firstContentfulPaint=0,a.parseDomTime=r.domComplete-r.domInteractive,a.initDomTreeTime=r.domInteractive-r.responseEnd,a.readyStart=r.fetchStart-s,a.redirectCount=r.redirectCount||0,a.compression=100*(1-r.encodedBodySize/r.decodedBodySize)||0,a.redirectTime=r.redirectEnd-r.redirectStart,a.appcacheTime=r.domainLookupStart-r.fetchStart,a.lookupDomainTime=r.domainLookupEnd-r.domainLookupStart;var u=r.secureConnectionStart;a.connectSslTime=u>0?r.connectEnd-u:0,a.connectTime=r.connectEnd-r.connectStart,a.requestTime=r.responseEnd-r.requestStart,a.requestDocumentTime=r.responseStart-r.requestStart,a.responseDocumentTime=r.responseEnd-r.responseStart,a.TTFB=r.responseStart-r.redirectStart,a.now=i();for(var p in a)a[p]=t(a[p]);var f=this.fmpObj.getFMP(),l=t(f.ts-s);this.fmp={time:l>0?l:t(f.ts),element:f.element?n(f.element.outerHTML):""},a.timing={};for(var h in r){var m=r[h],v=typeof m;"function"!==v&&(a.timing[h]=m,"number"===v&&(a.timing[h]=t(m,2)))}return a.firstScreen=Math.max.call(void 0,this.fmp.time,this.lcp.time,a.domReadyTime),a.timing.lcp=this.lcp,a.timing.fmp=this.fmp,a.timing.fid=this.fid,a},e.prototype.registerLoadAndHideEvent=function(){var e=this,t=function(){var t=e.getTimes();e.isNeedHideEvent&&t&&(e.http.sendPerformance(t),e.isNeedHideEvent=!1)};window.addEventListener("load",function(){setTimeout(function(){t()},0)});var r=!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),n=r?"pagehide":"beforeunload";window.addEventListener(n,function(){t()},!1)},e}(),E={src:"//127.0.0.1:3000/ma.gif",psrc:"//127.0.0.1:3000/pe.gif",pkey:"",subdir:"",rate:5,version:"",author:"",record:{isOpen:!0,src:"//cdn.jsdelivr.net/npm/rrweb@latest/dist/rrweb.min.js"},error:{isFilterErrorFunc:null,isFilterPromiseFunc:null},console:{isOpen:!0,isFilterLogFunc:null},crash:{isOpen:!0,validateFunc:null},event:{isFilterClickFunc:null},ajax:{isFilterSendFunc:null},identity:{value:"",getFunc:null}},y={setParams:o};return y});
